#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
مدير الطائرة المسيرة - الوحدة الرئيسية للتحكم
"""

import time
import math
import logging
from threading import Thread, Event
from datetime import datetime
from dronekit import connect, VehicleMode, LocationGlobalRelative
from pymavlink import mavutil
from config import DroneConfig

class DroneManager:
    def __init__(self, connection_string=None):
        self.config = DroneConfig
        self.connection_string = connection_string or self.config.CONNECTION_STRING
        self.vehicle = None
        self.is_connected = False
        self.mission_running = False
        self.stop_event = Event()
        
        # إعداد التسجيل
        self.setup_logging()
        
    def setup_logging(self):
        """إعداد نظام التسجيل"""
        logging.basicConfig(
            filename=self.config.LOG_FILE,
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s'
        )
        self.logger = logging.getLogger(__name__)
        
    def connect(self):
        """الاتصال بالطائرة المسيرة"""
        try:
            print(f"جاري الاتصال بالطائرة على {self.connection_string}")
            self.vehicle = connect(self.connection_string, wait_ready=True, timeout=60)
            self.is_connected = True
            
            # إضافة مستمعين للأحداث
            self.add_event_listeners()
            
            print("تم الاتصال بالطائرة بنجاح!")
            print(f"نوع الطائرة: {self.vehicle.version}")
            print(f"وضع الطيران الحالي: {self.vehicle.mode.name}")
            print(f"مستوى البطارية: {self.vehicle.battery.level}%")
            
            self.logger.info(f"تم الاتصال بالطائرة على {self.connection_string}")
            return True
            
        except Exception as e:
            print(f"خطأ في الاتصال: {e}")
            self.logger.error(f"خطأ في الاتصال: {e}")
            return False
    
    def add_event_listeners(self):
        """إضافة مستمعين لأحداث الطائرة"""
        @self.vehicle.on_attribute('mode')
        def mode_listener(vehicle, name, mode):
            print(f"تم تغيير وضع الطيران إلى: {mode.name}")
            self.logger.info(f"تغيير وضع الطيران إلى: {mode.name}")
        
        @self.vehicle.on_attribute('location.global_relative_frame')
        def location_listener(vehicle, name, location):
            if location:
                self.log_telemetry(location)
        
        @self.vehicle.on_attribute('battery')
        def battery_listener(vehicle, name, battery):
            if battery.level < self.config.LOW_BATTERY_THRESHOLD:
                print(f"تحذير: مستوى البطارية منخفض ({battery.level}%)")
                self.logger.warning(f"مستوى البطارية منخفض: {battery.level}%")
    
    def log_telemetry(self, location):
        """تسجيل بيانات القياس عن بعد"""
        try:
            with open(self.config.TELEMETRY_LOG, 'a') as f:
                timestamp = datetime.now().isoformat()
                f.write(f"{timestamp},{location.lat},{location.lon},{location.alt}\n")
        except:
            pass
    
    def arm_and_takeoff(self, altitude=None):
        """تجهيز الطائرة والإقلاع"""
        if not self.is_connected:
            print("الطائرة غير متصلة!")
            return False
        
        target_altitude = altitude or self.config.DEFAULT_ALTITUDE
        
        print("جاري تجهيز الطائرة للإقلاع...")
        print(f"الوضع الحالي: {self.vehicle.mode.name}")
        
        while not self.vehicle.is_armable:
            print("بانتظار تجهيز الطائرة...")
            time.sleep(1)
        
        # تغيير الوضع إلى GUIDED
        self.vehicle.mode = VehicleMode("GUIDED")
        while not self.vehicle.mode.name == "GUIDED":
            print("بانتظار تغيير الوضع إلى GUIDED...")
            time.sleep(1)
        
        # تجهيز المحركات
        self.vehicle.armed = True
        while not self.vehicle.armed:
            print("بانتظار تجهيز المحركات...")
            time.sleep(1)
        
        print("المحركات جاهزة!")
        print(f"الإقلاع إلى ارتفاع {target_altitude} متر...")
        
        # الإقلاع
        self.vehicle.simple_takeoff(target_altitude)
        
        # الانتظار للوصول إلى الارتفاع المطلوب
        while True:
            current_altitude = self.vehicle.location.global_relative_frame.alt
            print(f"الارتفاع الحالي: {current_altitude:.2f} متر")
            
            if current_altitude >= target_altitude * 0.95:
                print(f"تم الوصول إلى الارتفاع المطلوب ({target_altitude} متر)")
                break
            
            time.sleep(1)
        
        self.logger.info(f"تم الإقلاع إلى ارتفاع {target_altitude} متر")
        return True
    
    def goto_location(self, lat, lon, alt=None, speed=None):
        """الذهاب إلى موقع معين"""
        if not self.is_connected:
            return False
        
        target_alt = alt or self.config.DEFAULT_ALTITUDE
        target_speed = speed or self.config.DEFAULT_SPEED
        
        # تعيين السرعة
        self.set_airspeed(target_speed)
        
        # الذهاب إلى الموقع
        target_location = LocationGlobalRelative(lat, lon, target_alt)
        self.vehicle.simple_goto(target_location)
        
        print(f"توجيه إلى الموقع: ({lat}, {lon}) على ارتفاع {target_alt} متر")
        self.logger.info(f"توجيه إلى الموقع: ({lat}, {lon}) ارتفاع {target_alt} متر")
        
        return True
    
    def set_airspeed(self, speed):
        """تعيين سرعة الطيران"""
        self.vehicle.airspeed = speed
        print(f"تم تعيين سرعة الطيران إلى {speed} م/ث")
    
    def set_groundspeed(self, speed):
        """تعيين سرعة الأرض"""
        self.vehicle.groundspeed = speed
        print(f"تم تعيين سرعة الأرض إلى {speed} م/ث")
    
    def land(self):
        """الهبوط"""
        print("بدء عملية الهبوط...")
        self.vehicle.mode = VehicleMode("LAND")
        
        while self.vehicle.armed:
            print("جاري الهبوط...")
            time.sleep(1)
        
        print("تم الهبوط بنجاح!")
        self.logger.info("تم الهبوط بنجاح")
    
    def return_to_launch(self):
        """العودة إلى نقطة الإقلاع"""
        print("العودة إلى نقطة الإقلاع...")
        self.vehicle.mode = VehicleMode("RTL")
        self.logger.info("تفعيل وضع RTL (العودة إلى نقطة الإقلاع)")
    
    def execute_mission(self, waypoints):
        """تنفيذ مهمة مكونة من عدة نقاط"""
        if not waypoints:
            print("لا توجد نقاط للمهمة")
            return
        
        self.mission_running = True
        self.stop_event.clear()
        
        mission_thread = Thread(target=self._mission_executor, args=(waypoints,))
        mission_thread.start()
        
        return mission_thread
    
    def _mission_executor(self, waypoints):
        """منفذ المهمة (يعمل في خيط منفصل)"""
        try:
            print(f"بدء المهمة مع {len(waypoints)} نقطة")
            
            for i, wp in enumerate(waypoints):
                if self.stop_event.is_set():
                    print("تم إيقاف المهمة")
                    break
                
                print(f"النقطة {i+1}/{len(waypoints)}: ({wp['lat']}, {wp['lon']})")
                
                if not self.goto_location(wp['lat'], wp['lon'], wp.get('alt')):
                    print(f"فشل في الوصول إلى النقطة {i+1}")
                    break
                
                # الانتظار للوصول إلى النقطة
                while not self.reached_waypoint(wp, tolerance=5):
                    if self.stop_event.is_set():
                        break
                    time.sleep(1)
                
                if wp.get('action') == 'photo':
                    self.take_photo()
                elif wp.get('action') == 'hover':
                    time.sleep(wp.get('hover_time', 5))
            
            print("اكتملت المهمة!")
            self.mission_running = False
            
        except Exception as e:
            print(f"خطأ في تنفيذ المهمة: {e}")
            self.logger.error(f"خطأ في تنفيذ المهمة: {e}")
            self.mission_running = False
    
    def reached_waypoint(self, waypoint, tolerance=5):
        """التحقق من الوصول إلى النقطة المستهدفة"""
        current = self.vehicle.location.global_relative_frame
        
        distance = self.get_distance_metres(
            current,
            LocationGlobalRelative(waypoint['lat'], waypoint['lon'], waypoint.get('alt', 10))
        )
        
        return distance <= tolerance
    
    def take_photo(self):
        """التقاط صورة (محاكاة)"""
        print("جاري التقاط صورة...")
        # هنا يمكن إضافة كود للتحكم في الكاميرا
        time.sleep(2)
        print("تم التقاط الصورة")
        self.logger.info("تم التقاط صورة")
    
    def get_distance_metres(self, location1, location2):
        """حساب المسافة بين موقعين بالأمتار"""
        dlat = location2.lat - location1.lat
        dlong = location2.lon - location1.lon
        
        return math.sqrt((dlat*dlat) + (dlong*dlong)) * 1.113195e5
    
    def get_telemetry(self):
        """الحصول على بيانات القياس عن بعد الحالية"""
        if not self.vehicle:
            return None
        
        return {
            'location': {
                'lat': self.vehicle.location.global_frame.lat,
                'lon': self.vehicle.location.global_frame.lon,
                'alt': self.vehicle.location.global_relative_frame.alt
            },
            'attitude': {
                'roll': self.vehicle.attitude.roll,
                'pitch': self.vehicle.attitude.pitch,
                'yaw': self.vehicle.attitude.yaw
            },
            'velocity': {
                'vx': self.vehicle.velocity[0],
                'vy': self.vehicle.velocity[1],
                'vz': self.vehicle.velocity[2]
            },
            'battery': {
                'level': self.vehicle.battery.level,
                'voltage': self.vehicle.battery.voltage,
                'current': self.vehicle.battery.current
            },
            'mode': self.vehicle.mode.name,
            'armed': self.vehicle.armed,
            'gps_fix': self.vehicle.gps_0.fix_type,
            'satellites': self.vehicle.gps_0.satellites_visible
        }
    
    def stop_mission(self):
        """إيقاف المهمة الحالية"""
        self.stop_event.set()
        self.mission_running = False
        print("تم طلب إيقاف المهمة")
    
    def disconnect(self):
        """فصل الاتصال بالطائرة"""
        if self.vehicle:
            self.vehicle.close()
            self.is_connected = False
            print("تم فصل الاتصال بالطائرة")
            self.logger.info("تم فصل الاتصال بالطائرة")